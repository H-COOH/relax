<?php

?>
<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<title>Doc</title>
	<meta name="viewport" content="initial-scale=0.75,width=device-width">
	<script src="face-api.min.js"></script>
	<script src="../code/popper.js"></script>
	<script src="../code/bootstrap.js"></script>
	<link href="../code/bootstrap.css" rel="stylesheet">
</head>
<body>
<div class="modal fade" id="drop-next-0" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">提示</h5>
			</div>
			<div class="modal-body">
				<p class="mb-0">那就去做一些事让自己开心吧！</p>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="drop-next-1" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">提示</h5>
			</div>
			<div class="modal-body">
				<p>请证明它！</p>
				<p class="fw-light mb-0">验证过程需要 camera 权限，但仅在您本地进行</p>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
				<button class="btn btn-primary" onclick="show()">继续</button>
			</div>
		</div>
	</div>
</div>
<div class="d-flex flex-column" style="height:100vh">
	<nav class="navbar navbar-dark bg-primary sticky-top p-2">
		<div class="container-fluid">
			<a class="navbar-brand text-xl" href="./">Happy</a>
		</div>
	</nav>

	<div id="choose" class="flex-grow-1 d-flex flex-column justify-content-center align-items-center p-4">
		<h2 class="mb-4">你今天开心吗？</h2>
		<div class="border p-4" id="form" style="width:320px">
			<div>
				<button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#drop-next-1">开心</button>
			</div>
			<div class="my-4"></div>
			<div>
				<button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#drop-next-0">不开心</button>
			</div>
		</div>
	</div>

	<div id="verify" class="d-none flex-grow-1 d-flex flex-column justify-content-center p-4">
		<div class="flex-grow-1 d-flex flex-row justify-content-evenly align-items-center p-4">
			<div class="col-8 h-100 p-3 text-center">
				<video id="video" onloadedmetadata="check()" style="width:auto;height:100%" autoplay muted playsinline></video>
			</div>
			<div class="col-4 d-flex flex-column justify-content-center align-items-center">
				<table class="table table-striped table-bordered" style="width:200px">
					<thead>
					<tr>
						<th>情绪</th>
						<th>概率</th>
					</tr>
					</thead>
					<tbody id="res"></tbody>
				</table>
			</div>
		</div>
		<div class="d-flex flex-row justify-content-evenly align-items-center mb-5" style="height:40px">
			<div class="col-8">
				<div class="progress">
					<div id="now" class="progress-bar progress-bar-striped" role="progressbar"></div>
				</div>
			</div>
			<div class="col-4 text-center">
				<button id="submit" class="btn btn-success" disabled>提交</button>
			</div>
		</div>
	</div>
</div>
</body>
<style>
	#video
	{
		width:100%;
		height:auto;
		max-width:100%;
		max-height:100%;
	}
</style>
<script>
	let fi=id=>document.getElementById(id);

	function show()
	{
		navigator.mediaDevices.getUserMedia({video:true})
			.then(()=>
			{
				fi("choose").classList.add("d-none");
				fi("verify").classList.remove("d-none");
				bootstrap.Modal.getInstance(fi("drop-next-1")).hide();
				run();
			})
			.catch(()=>alert("获取 camera 权限失败"));
	}

	async function run()
	{
		await faceapi.nets.tinyFaceDetector.load("./");
		await faceapi.loadFaceExpressionModel("./");

		fi("video").srcObject= await navigator.mediaDevices.getUserMedia({video:true});
	}

	async function check()
	{
		let video=fi("video");

		if(video.paused||video.ended|| !faceapi.nets.tinyFaceDetector.params)
			return setTimeout(()=>check());

		let options=new faceapi.TinyFaceDetectorOptions({inputSize:224});
		let result=await faceapi.detectSingleFace(video,options).withFaceExpressions();

		if(result)
		{
			fi("now").style.width=(result.expressions.happy*100).toFixed(2)+"%";

			let expressions=Object.entries(result.expressions).sort((a,b)=>b[1]-a[1]);
			fi("res").innerHTML="";
			for(let [k,v] of expressions)
			{
				let tr=document.createElement("tr");
				tr.innerHTML=`<td>${k}</td><td>${(v*100).toFixed(2)}%</td>`;
				fi("res").appendChild(tr);
			}

			if(result.expressions.happy>0.9999)
			{
				alert("是的，你很开心！祝你每天都开心！");
				video.pause();
				fi("submit").disabled=false;
				return;
			}
		}

		setTimeout(()=>check());
	}
</script>
</html>